<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="3">
  <include path="explore_house.xml"/>

  <BehaviorTree ID="cat_hunter">
    <RetryUntilSuccessful num_attempts="999999">
      <Fallback>
        <Parallel failure_threshold="1"
                  success_threshold="1">
          <SubTree ID="explore_house"
                   __shared_blackboard="false"/>
          <ForceFailure>
            <MonitorObjects max_delay="0.000000"
                            target_objects="cat, dog, horse"
                            timeout="1e6"
                            topic_name="tracked_objects"
                            tracked_object="{tracked_object}"
                            tracked_object_pose="{tracked_object_pose}"/>
          </ForceFailure>
        </Parallel>
        <Parallel failure_threshold="1"
                  success_threshold="1">
          <ForceFailure>
            <FollowPose action_name="pose_follower/follow"
                        distance="0.8"
                        goal=""
                        server_timeout="5.000000"
                        stop_at_distance="false"
                        time_limit="25"
                        error="{follow_error}"
                        feedback="{follow_feedback}"/>
          </ForceFailure>
          <RetryUntilSuccessful num_attempts="999999">
            <Sequence>
              <MonitorObjects name="TargetVisible"
                              max_delay="0.000000"
                              target_objects="cat, dog, horse"
                              timeout="0.2"
                              topic_name="tracked_objects"
                              tracked_object="{tracked_object}"
                              tracked_object_pose="{tracked_object_pose}"/>
              <GetRobotPose timeout="1"
                            error=""
                            robot_pose="{robot_pose}"/>
              <TargetReachable follow_feedback="{follow_feedback}"
                               max_angle="0.2"
                               max_dist="1.0"
                               robot_pose="{robot_pose}"/>
              <AimCannon service_name="cannon_command"
                         timeout="5"/>
              <FireCannon service_name="cannon_command"
                          shots="1"
                          timeout="5"/>
              <Sleep duration="1.0"/>
              <AlwaysFailure _description="Replace with failing on exhausted ammo"/>
            </Sequence>
          </RetryUntilSuccessful>
        </Parallel>
      </Fallback>
    </RetryUntilSuccessful>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="AimCannon">
      <input_port name="service_name"
                  default="cannon_command"
                  type="std::string">name of the ROS service</input_port>
      <input_port name="timeout"
                  default="100"
                  type="unsigned int">timeout to connect to server (milliseconds)</input_port>
    </Action>
    <Action ID="FireCannon">
      <input_port name="service_name"
                  type="std::string">name of the ROS service</input_port>
      <input_port name="shots"
                  type="unsigned int"/>
      <input_port name="timeout"
                  default="100"
                  type="unsigned int">timeout to connect to server (milliseconds)</input_port>
    </Action>
    <Action ID="FollowPose">
      <input_port name="action_name"
                  type="std::string">name of the ROS action client</input_port>
      <input_port name="distance"
                  type="float"/>
      <input_port name="goal"
                  type="thorp_msgs::FollowPoseGoal_&lt;std::allocator&lt;void&gt; &gt;">goal to send to the action server</input_port>
      <input_port name="server_timeout"
                  default="5.000000"
                  type="double">timeout to connect to server (seconds)</input_port>
      <input_port name="stop_at_distance"
                  type="bool"/>
      <input_port name="time_limit"
                  type="float"/>
      <output_port name="error"
                   type="unsigned char"/>
      <output_port name="feedback"
                   type="thorp_msgs::FollowPoseFeedback_&lt;std::allocator&lt;void&gt; &gt;"/>
    </Action>
    <Action ID="GetRobotPose">
      <input_port name="timeout"
                  type="double"/>
      <output_port name="error"
                   type="unsigned int"/>
      <output_port name="robot_pose"
                   type="geometry_msgs::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
    </Action>
    <Action ID="MonitorObjects">
      <input_port name="max_delay"
                  default="0.000000"
                  type="double">max delay wrt Time::now() (sec); ignored if negative</input_port>
      <input_port name="target_objects"
                  type="std::string">Comma-separated list of objects to track</input_port>
      <input_port name="timeout"
                  default="1.000000"
                  type="double">timeout to subscribe to topic (sec)</input_port>
      <input_port name="topic_name"
                  type="std::string">name of the ROS topic</input_port>
      <output_port name="tracked_object"
                   type="cob_perception_msgs::Detection_&lt;std::allocator&lt;void&gt; &gt;"/>
      <output_port name="tracked_object_pose"
                   type="geometry_msgs::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
    </Action>
    <Action ID="Sleep">
      <input_port name="duration"
                  type="double"/>
    </Action>
    <Condition ID="TargetReachable">
      <input_port name="follow_feedback"
                  type="thorp_msgs::FollowPoseFeedback_&lt;std::allocator&lt;void&gt; &gt;"/>
      <input_port name="max_angle"
                  type="float"/>
      <input_port name="max_dist"
                  type="float"/>
      <input_port name="robot_pose"
                  type="geometry_msgs::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
    </Condition>
  </TreeNodesModel>

</root>
